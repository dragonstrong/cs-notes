[toc]



# 1.渲染二级三级分类数据

对应视频p138
需求：获取如下结构数据
一级分类列表中每个一级分类包含二级子分类列表，每个二级子分类包含三级子分类列表
![image.png](https://cdn.nlark.com/yuque/0/2024/png/34372585/1711375864856-04ea2ed2-01d4-4388-a109-c14d4d2641c0.png#averageHue=%23fefefd&clientId=u9a098ef6-77f0-4&from=paste&height=866&id=u4497286f&originHeight=866&originWidth=395&originalType=binary&ratio=1&rotation=0&showTitle=false&size=25265&status=done&style=none&taskId=u6ffa2efc-25ee-4273-8666-e1a30aa16dc&title=&width=395)

```java
public Map<String, List<Catalog2Vo>> getCatalogJson(){
    Map<String, List<Catalog2Vo>> map=null;  // 结果
    // 找一级分类
    List<CategoryEntity> categoryEntityList=getBaseMapper().selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid",0));
    if (categoryEntityList!=null){
        // 对每一个一级分类找二级分类
        // 封装成map   key=一级分类的catId  value=List<Catalog2Vo>
        map=categoryEntityList.stream().collect(Collectors.toMap(k->{
            return k.getCatId().toString();
        },v->{
            // 找v的二级分类列表
            List<Catalog2Vo> catalog2VoList=null;
            List<CategoryEntity> category2Entities=getBaseMapper().selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid",v.getCatId()));
            if (category2Entities!=null){
                // 将category2Entities封装成List<Catalog2Vo>
                // 先找3级子分类列表
                catalog2VoList=category2Entities.stream().map(l2->{
                    List<CategoryEntity> category3Entities=getBaseMapper().selectList(new QueryWrapper<CategoryEntity>().eq("parent_cid",l2.getCatId()));
                    List<Catalog2Vo.Category3Vo> category3VoList=null;
                    if (category3Entities!=null){
                        category3VoList=category3Entities.stream().map(l3->{
                            Catalog2Vo.Category3Vo catalog3Vo=new Catalog2Vo.Category3Vo(l2.getCatId().toString(),l3.getCatId().toString(),l3.getName());
                            return catalog3Vo;
                        }).collect(Collectors.toList());
                    }
                    Catalog2Vo catalog2Vo=new Catalog2Vo(l2.getParentCid().toString(),category3VoList,l2.getCatId().toString(),l2.getName());
                    return catalog2Vo;
                }).collect(Collectors.toList());
            }
            return catalog2VoList;
        }));
    }
    return map;
}
```
![image.png](https://cdn.nlark.com/yuque/0/2024/png/34372585/1711375992991-73b8858e-2a86-4c6e-80fc-8cb175030fbf.png#averageHue=%23fcfbf9&clientId=u9a098ef6-77f0-4&from=paste&height=443&id=u7aa53b52&originHeight=443&originWidth=277&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20199&status=done&style=none&taskId=ua5dc3986-3f85-4a5d-8c8b-87910f7cd46&title=&width=277)





# 2.  逻辑删除

参考：https://baomidou.com/guides/logic-delete/

(1) 配置全局逻辑删除规则

```yaml
mybatis-plus:
  global-config:
    db-config:
      logic-delete-value: 1 # 配置全局逻辑删除规则
      logic-not-delete-value: 0
```

(2)对数据库表中想要作为逻辑删除的字段加**@TableLogic**注解

```java
@Data
@TableName("pms_category")
public class CategoryEntity implements Serializable {
    /**
	 * 是否显示[0-不显示，1显示] ,@TableLogic逻辑删除注解,  若与全局配置相反直接用value deval注明
	 */
	@TableLogic(value = "1",delval = "0")
	private Integer showStatus;
}
```

(3)直接用BaseMapper里的deleteBatchIds

```java
@Override
public void removeMenuByIds(List<Long> asList) {
    // TODO 检查删除菜单是否被引用
    // 逻辑删除
    baseMapper.deleteBatchIds(asList);
}
```



测试：逻辑删除cat_id为988的数据后

![image-20240825204339507](assets/image-20240825204339507.png)



# 3.对象存储

## 3.1 功能开通及试用

阿里云OSS：https://oss.console.aliyun.com/

帮助文档：https://help.aliyun.com/zh/oss/user-guide/

1.开通OSS服务

2.创建Bucket

![image-20240826212751557](assets/image-20240826212751557.png)

![image-20240826213320372](assets/image-20240826213320372.png)

3.上传文件

![image-20240826213517183](assets/image-20240826213517183.png)

4. 使用URL直接访问

![image-20240826213646767](assets/image-20240826213646767.png)





## 3.2 java文件上传OSS

阿里云对象存储-服务端签名后直接上传

用户向服务器请求签名（根据账号密码等信息生成策略返给用户），之后用户直接将文件上传到OSS，既减轻了服务器带宽压力，还避免了账号密码等信息泄露。

![image-20240826213948547](assets/image-20240826213948547.png)

帮助文档：https://help.aliyun.com/zh/oss/user-guide/



https://help.aliyun.com/zh/oss/user-guide/simple-upload?spm=a2c4g.11186623.0.0.6c331f49lDKkP9

![image-20240826214740158](assets/image-20240826214740158.png)





### 3.2.1 引入依赖

```xml
<dependency>
    <groupId>com.aliyun.oss</groupId>
    <artifactId>aliyun-sdk-oss</artifactId>
    <version>3.17.4</version>
</dependency>
```

Java 9及以上的版本，需要添加JAXB相关依赖:

```xml
<dependency>
    <groupId>javax.xml.bind</groupId>
    <artifactId>jaxb-api</artifactId>
    <version>2.3.1</version>
</dependency>
<dependency>
    <groupId>javax.activation</groupId>
    <artifactId>activation</artifactId>
    <version>1.1.1</version>
</dependency>
<!-- no more than 2.3.3-->
<dependency>
    <groupId>org.glassfish.jaxb</groupId>
    <artifactId>jaxb-runtime</artifactId>
    <version>2.3.3</version>
</dependency>
```



### 3.2.2 java上传文件流

![image-20240826220608605](assets/image-20240826220608605.png)





创建子账户AccessKey

![image-20240826220810206](assets/image-20240826220810206.png)

![image-20240826220904233](assets/image-20240826220904233.png)



![image-20240826221034156](assets/image-20240826221034156.png)





添加权限：

![image-20240826222330956](assets/image-20240826222330956.png)



![image-20240826222504393](assets/image-20240826222504393.png)



存储空间名字（bucketName）

![image-20240826222652319](assets/image-20240826222652319.png)

代码里accessKeyId和accessKeySecret直接复制上面刚开通的RAN访问控制里的

```java
import com.aliyun.oss.OSS;
import com.aliyun.oss.OSSClientBuilder;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.InputStream;

@SpringBootTest(classes = GulimallProductApplication.class )
public class GulimallProductApplicationTest {
    @Test
    public void upLoadOSS() throws FileNotFoundException {
        // Endpoint以上海为例，其它Region请按实际情况填写。
        String endpoint = "https://oss-cn-shanghai.aliyuncs.com";
        // 运行本代码示例之前，请确保已设置OSS_ACCESS_KEY_ID和OSS_ACCESS_KEY_SECRET
        String accessKeyId="LTAI5tFTTUWqBbq8F9zzvhVb";
        String accessKeySecret="9EvG2ZhCor8ZutCWrccFzJLDtaxDtU";
        // 创建OSSClient实例
        OSS ossClient=new OSSClientBuilder().build(endpoint,accessKeyId,accessKeySecret);
        // 上传文件流
        InputStream inputStream = new FileInputStream("C:\\Users\\dragon\\Desktop\\1.jpg");
        String bucketName = "gulimall-qianglong";
        // 上传后在OSS里的文件名
        String objectName = "1.jpg";
        ossClient.putObject(bucketName,objectName,inputStream);
        // 关闭OSSClient
        ossClient.shutdown();
        log.info("上传成功");
    }
}
```

上传成功：

![image-20240826223729702](assets/image-20240826223729702.png)





一般将配置信息写到yml里：

```yaml
alibaba:
  oss:
    endpoint: https://oss-cn-shanghai.aliyuncs.com #Endpoint按实际Region填写。
    accessKeyId: LTAI5tFTTUWqBbq8F9zzvhVb  #OSS_ACCESS_KEY_ID
    accessKeySecret: 9EvG2ZhCor8ZutCWrccFzJLDtaxDtU #OSS_ACCESS_KEY_SECRET
```



```java
@Configuration
public class OssConfig {
    @Value("${alibaba.oss.endpoint}")
    private String endpoint;
    @Value("${alibaba.oss.accessKeyId}")
    private String accessKeyId;
    @Value("${alibaba.oss.accessKeySecret}")
    private String accessKeySecret;
    @Bean
    public OSS ossClient(){
        return new OSSClientBuilder().build(endpoint,accessKeyId,accessKeySecret);
    }
}
```



```java
@SpringBootTest(classes = GulimallProductApplication.class )
public class GulimallProductApplicationTest {
    @Autowired
    OSS oss;
    
    @Test
    public void upLoadOSS() throws FileNotFoundException {
        // 上传文件流
        InputStream inputStream = new FileInputStream("C:\\Users\\dragon\\Desktop\\1.jpg");
        String bucketName = "gulimall-qianglong";
        // 要上传的文件名
        String objectName = "2.jpg";
        oss.putObject(bucketName,objectName,inputStream);
        // 关闭OSSClient
        oss.shutdown();
    }
```

### 3.2.3 服务端签名后web直传

参考：https://help.aliyun.com/zh/oss/use-cases/java-1?spm=a2c4g.11186623.0.0.7c475d03UA9gSY#concept-ahk-rfz-2fb

![image-20240826213948547](assets/image-20240826213948547.png)

允许跨域访问：

![image-20240827012413364](assets/image-20240827012413364.png)





品牌管理：只有查询，无新增、删除按钮

![image-20240827013557817](assets/image-20240827013557817.png)

原因：前端加了权限判断

![image-20240827013707076](assets/image-20240827013707076.png)

解决：该方法先全部返回true

![image-20240827013458910](assets/image-20240827013458910.png)

重启：

![image-20240827013819328](assets/image-20240827013819328.png)





前端修改OSS相关配置：

两个

![image-20240827014744583](assets/image-20240827014744583.png)



![image-20240827014849887](assets/image-20240827014849887.png)



测试文件上传功能：

![image-20240827015020250](assets/image-20240827015020250.png)

![image-20240827015222668](assets/image-20240827015222668.png)
